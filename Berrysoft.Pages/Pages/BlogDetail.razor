@page "/blog/{filename}"

@using Berrysoft.Pages.Data
@using Berrysoft.Pages.HighlightJs
@using Markdig
@using Pek.Markdig.HighlightJs

@implements IDisposable

@inject ILocalizationService Localization
@inject IBlogService BlogService
@inject IHighlightJsEngine HighlightJsEngine

@if (notFound)
{
    <NotFoundComponent />
}
else if (text != null && post != null)
{
    <div class="fade-in fade-in-1">
        <h1>@post.Title</h1>
        <p class="text-secondary">
            <time datetime="@post.Date">@post.Date.ToString(Localization.Culture.DateTimeFormat.LongDatePattern, Localization.Culture)</time>
        </p>
    </div>
    <div class="fade-in fade-in-2">
        @if (plainText)
        {
            @text
        }
        else
        {
            @((MarkupString)text)
        }
    </div>
}

@code {
    [Parameter]
    public string Filename { get; set; }

    private BlogPost post;
    private string text;
    private bool notFound;
    private bool plainText;

    private MarkdownPipeline markdigPipeline;

    protected override async Task OnInitializedAsync()
    {
        if (markdigPipeline == null)
            markdigPipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().UseHighlightJs(HighlightJsEngine).Build();
        Localization.LanguageChanged += OnLanguageChanged;
        await Task.Run(async () =>
        {
            post = await BlogService.GetBlogPostAsync(Filename);
            if (post == null)
            {
                text = null;
                plainText = true;
                notFound = true;
            }
            else
            {
                var content = await BlogService.GetBlogPostContentAsync(Filename);
                text = post.Type switch
                {
                    BlogPostType.Html => content,
                    BlogPostType.Markdown => Markdown.ToHtml(content, markdigPipeline),
                    _ => content
                };
                plainText = post.Type == BlogPostType.Text;
                notFound = false;
            }
        });
    }

    private void OnLanguageChanged(object sender, string e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Localization.LanguageChanged -= OnLanguageChanged;
    }
}
